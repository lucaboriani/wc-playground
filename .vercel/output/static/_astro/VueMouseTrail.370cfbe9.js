import{M as I,a as E,b as P,W as C,A as D,T as R,B as U,P as L}from"./HTMLText.439161f2.js";import{I as b}from"./IntersectionHandler.7eaf436d.js";import{_ as W}from"./_plugin-vue_export-helper.c27b6911.js";import{g as A,o as S,h as T,c as $,d as z}from"./runtime-core.esm-bundler.61f2b7ad.js";class G extends I{constructor(e=200,n,r=0){super(new Float32Array(n.length*4),new Float32Array(n.length*4),new Uint16Array((n.length-1)*6)),this.points=n,this._width=e,this.textureScale=r,this.build()}get width(){return this._width}build(){const e=this.points;if(!e)return;const n=this.getBuffer("aVertexPosition"),r=this.getBuffer("aTextureCoord"),o=this.getIndex();if(e.length<1)return;n.data.length/4!==e.length&&(n.data=new Float32Array(e.length*4),r.data=new Float32Array(e.length*4),o.data=new Uint16Array((e.length-1)*6));const s=r.data,l=o.data;s[0]=0,s[1]=0,s[2]=0,s[3]=1;let p=0,a=e[0];const u=this._width*this.textureScale,h=e.length;for(let t=0;t<h;t++){const i=t*4;if(this.textureScale>0){const d=a.x-e[t].x,g=a.y-e[t].y,_=Math.sqrt(d*d+g*g);a=e[t],p+=_/u}else p=t/(h-1);s[i]=p,s[i+1]=0,s[i+2]=p,s[i+3]=1}let c=0;for(let t=0;t<h-1;t++){const i=t*2;l[c++]=i,l[c++]=i+1,l[c++]=i+2,l[c++]=i+2,l[c++]=i+1,l[c++]=i+3}r.update(),o.update(),this.updateVertices()}updateVertices(){const e=this.points;if(e.length<1)return;let n=e[0],r,o=0,s=0;const l=this.buffers[0].data,p=e.length,a=this.textureScale>0?this.textureScale*this._width/2:this._width/2;for(let u=0;u<p;u++){const h=e[u],c=u*4;u<e.length-1?r=e[u+1]:r=h,s=-(r.x-n.x),o=r.y-n.y;const t=Math.sqrt(o*o+s*s);t<1e-6?(o=0,s=0):(o/=t,s/=t,o*=a,s*=a),l[c]=h.x+o,l[c+1]=h.y+s,l[c+2]=h.x-o,l[c+3]=h.y-s,n=h}this.buffers[0].update()}update(){this.textureScale>0?this.build():this.updateVertices()}}class H extends E{constructor(e,n,r=0){const o=new G(e.height,n,r),s=new P(e);r>0&&(e.baseTexture.wrapMode=C.REPEAT),super(o,s),this.autoUpdate=!0}_render(e){const n=this.geometry;(this.autoUpdate||n._width!==this.shader.texture.height)&&(n._width=this.shader.texture.height,n.update()),super._render(e)}}let f;async function B(x){f=new D({background:"#000000",resizeTo:x}),x.appendChild(f.view);const e=R.from("/trail.png"),n=[],r=[],o=20,s=100,l=[];for(let t=0;t<o;t++)n.push(0),r.push(0);for(let t=0;t<s;t++)l.push(new L(0,0));const p=new H(e,l);p.blendmode=U.ADD,f.stage.addChild(p);let a=null;f.stage.eventMode="static",f.stage.hitArea=f.screen,f.stage.on("mousemove",t=>{a=a||{x:0,y:0},a.x=t.global.x,a.y=t.global.y}),f.ticker.add(()=>{if(a){n.pop(),n.unshift(a.x),r.pop(),r.unshift(a.y);for(let t=0;t<s;t++){const i=l[t],d=c(n,t/s*o),g=c(r,t/s*o);i.x=d,i.y=g}}});function u(t,i){return t<0&&(t=0),t>i.length-1&&(t=i.length-1),i[t]}function h(t,i,d){return i*(u(t+1,d)-u(t-1,d))/2}function c(t,i,d){d==null&&(d=1);const g=Math.floor(i),_=[h(g,d,t),h(g+1,d,t)],M=[u(g,t),u(g+1,t)];i-=g;const y=i*i,m=i*y;return(2*m-3*y+1)*M[0]+(m-2*y+i)*_[0]+(-2*m+3*y)*M[1]+(m-y)*_[1]}}function w(){console.log("app start"),f.start()}function v(){console.log("app stop"),f.stop()}function V(){f.stop(),f.destroy()}const O={__name:"VueMouseTrail",setup(x,{expose:e}){e();const n=A(null),r=l=>{console.log("handleAppIntersection");const{isIntersecting:p}=l;p?w():v()},o=()=>{console.log("handleVisibilityChange"),document.visibilityState==="visible"?n.current.getBoundingClientRect().top+window.innerHeight>0&&w():v()};S(()=>{console.log(n.value);const l={root:null,rootMargin:"0px",threshold:.01};b.init(l),b.observe(n.value,r),B(n.value),document.addEventListener("visibilitychange",o)}),T(()=>{document.removeEventListener("visibilitychange",o),b.unobserve(n.current),V()});const s={app:n,handleAppIntersection:r,handleVisibilityChange:o,ref:A,onMounted:S,onUnmounted:T,get initTrail(){return B},get start(){return w},get stop(){return v},get destroy(){return V},get IntersectionHandler(){return b}};return Object.defineProperty(s,"__isScriptSetup",{enumerable:!1,value:!0}),s}},q={ref:"app",class:"flex grow pr-2 h-96"};function X(x,e,n,r,o,s){return z(),$("div",q,null,512)}const k=W(O,[["render",X]]);export{k as default};
